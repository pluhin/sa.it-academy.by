---
- hosts: work_shop_01
  pre_tasks:
  - debug:
      msg: "{{ ansible_host }}"
  - name: Output hostname
    shell: hostname
    register: hostname
  - debug:
      msg: "{{ hostname.stdout }}"
  - name: Install packages for db and application
    apt:
      name: "{{ apt_redmine_packages }}"
      state: latest
      update_cache: yes
  roles:
    - mysql_db
    - app
  tasks:
  - name: "Add {{ app_fqdn }} to host file"
    shell: echo "127.0.0.1       {{ app_fqdn }}" >> /etc/hosts
    tags: 
      - test

  - uri:
      url: "http://{{ app_fqdn }}"
      return_content: yes
    register: this
    failed_when: "'Jean-Philippe Lang' not in this.content"
    tags: 
      - test

  - lineinfile:
      path: /etc/hosts
      state: absent
      regexp: '^127.0.0.1       {{ app_fqdn }}'
    tags: 
      - test
      - always

  - name: Check connect
    block:
      - name: Check connection to host
        wait_for:
          host: 'localhost'
          port: '80'
          timeout: 5
        register: out
      - name: Slack notofocation
        slack:
          token: "{{ slack_token }}"
          msg: '{{ ansible_hostname}} Checks: good'
          channel: '#redmine-notification'
          username: 'Redmine'
          icon_url: ''
          parse: 'full'
    rescue:
      - name: Send notification
        slack:
          token: "{{ slack_token }}"
          msg: '{{ ansible_hostname }} Checks: failed'
          channel: '#redmine-notification'
          username: 'Redmine'
          icon_url: ''
          parse: 'full'
   
  - name: Test
    uri:
      url: "http://localhost"
      return_content: yes
    register: out_uri
  - name: Print output
    debug:
      msg: "Status: {{ out_uri.status }}"
