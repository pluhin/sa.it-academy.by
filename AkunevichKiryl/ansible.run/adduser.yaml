---
- hosts: run
  become: yes
  tasks:

  - name: Create user
    debug:
      msg: "New username {{new_user}} "

  - name: Creating user {{ new_user }}
    user:
      name: "{{new_user}}"
      shell: /bin/bash
      state: present

  - name: Create ssh-key
    user:
      name: "{{new_user}}"
      generate_ssh_key: yes
      state: present

  - name: Set authorized key taken from file
    authorized_key:
      user: "{{new_user}}"
      state: present
      key: "{{ lookup('file', '/root/.ssh/id_rsa.pub') }}"


  - name: "Allow admin users to sudo without a password"
    lineinfile:
      dest: "/etc/sudoers"
      state: present
      regexp: "^%new_user"
      line: "%new_user ALL=(ALL) NOPASSWD: ALL"

  - name: Check sudo rule
    lineinfile:
      dest: "/etc/sudoers"
      state: present
      regexp: "^%new_user"
      line: "{{new_user}} ALL=(ALL) NOPASSWD: ALL"
      validate: "visudo -cf %s"

