apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: pod-cpu-mem-overload
  namespace: monitoring
  labels:
    release: kube-prometheus-stack
spec:
  groups:
  - name: pod-cpu-mem-overload
    rules:
    - alert: PodCpuOverload
      expr: sum by (namespace, pod) (
              rate(container_cpu_usage_seconds_total{container!="",container!="POD"}[2m])
            ) > 0.5
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "CPU overload on pod {{ $labels.pod }}"
        description: "Pod {{ $labels.pod }} in {{ $labels.namespace }} has CPU usage > 0.5 core for 2m."

    - alert: PodMemoryOverload
      expr: sum by (namespace, pod) (
              container_memory_usage_bytes{container!="",pod!=""}
              /
              container_spec_memory_limit_bytes{container!="",pod!=""}
            ) > 0.5
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "Memory overload on pod {{ $labels.pod }}"
        description: "Pod {{ $labels.pod }} in {{ $labels.namespace }} is using more than 50% of its memory limit for 2m."
