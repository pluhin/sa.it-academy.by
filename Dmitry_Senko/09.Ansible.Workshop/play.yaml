---
- hosts: ec_workshop
  # gather_facts: no
  gather_facts: yes # to get "ansible_hostname" in "Notify Slack of Playbook Failure"
  become: true

  pre_tasks:
    - name: check host
      shell: | 
        hostname
      register: out
      tags: 
        - info
    - name: Show host
      debug:
        msg: "{{ out.stdout }}"
      tags: 
        - info

  roles:
    - mysql
    - redmine

  tasks:
    - name: Connectivity checks
      block:
        - name: "Add {{ app_fqdn }} to host file"
          shell: echo "127.0.0.1       {{ app_fqdn }}" >> /etc/hosts
          tags:
            - test
        - uri:
            url: "http://{{ app_fqdn }}"
            return_content: yes
          register: this
          failed_when: "'Jean-Philippe Lang' not in this.content"
          tags:
            - test
        - lineinfile:
            path: /etc/hosts
            state: absent
            regexp: '^127.0.0.1       {{ app_fqdn }}'
          tags:
            - test
        - name: Notify Slack if all good
          include_role:
            name: slack_handler
            tasks_from: good
      rescue:
        - include_role:
            name: slack_handler
            tasks_from: failure

    