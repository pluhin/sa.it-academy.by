---
- name: Check if we have SUDO with NOPASSWD
  block:
    - name: Check sudo
      command: sudo -v
      register: result
      failed_when: "'FAILED' in result.stderr"
  rescue:
    - name: Send notification to Slack
      slack:
        token: TFBPBNB2L/BTQ4WV8P3/Yq8fc1FORDH7YrtGijv7CwBn
        msg: "SUDO NOPASSWD check FAILED on {{ ansible_host }}"
        channel: 'sa_notifications'
        username: 'incoming-webhook'
        parse: 'full'

- name: Check connection to Debian repo
  include: debian_repo.yaml
  when: ansible_os_family == "Debian"

- name: Check connection to Centos repo
  include: centos_repo.yaml
  when: ansible_os_family == "RedHat"

- name: Check connection to Pip repo
  include: pip_repo.yaml

- name: Check connection to DockerHub repo
  include: docker_hub_repo.yaml

- name: Check if we have enough RAM
  block:
    - name: ram check
      fail:
      when: ansible_memory_mb.real.total < 20000
  rescue:
    - name: Send notofication to Slack
      slack:
        token: TFBPBNB2L/BTQ4WV8P3/Yq8fc1FORDH7YrtGijv7CwBn
        msg: "RAM check FAILED on {{ ansible_host }}"
        channel: 'sa_notifications'
        username: "incoming-webhook"
        parse: "full"

- name: Check if we have enough HDD space
  block:
    - name: Check HDD space
      fail:
      when: (item.mount == '/') and (item.size_available / 1200000000) < 1000
      with_items: "{{ ansible_mounts }}"
  rescue:
    - name: Send notofication to Slack
      slack:
        token: TFBPBNB2L/BTQ4WV8P3/Yq8fc1FORDH7YrtGijv7CwBn
        msg: "HDD check FAILED on {{ ansible_host }}"
        channel: 'sa_notifications'
        username: "incoming-webhook"
        parse: "full"
