---
- name: Deploy for Debian systems
  include: nginx_debian.yaml
  when: ansible_os_family == 'Debian'

- name: Deploy for RedHat systems
  include: nginx_redhat.yaml
  when: ansible_os_family == 'RedHat'

- name: Mkdir directory
  file:
    path: "{{ default_home1 }}"
    state: directory
    
- name: Mkdir directory
  file:
    path: "{{ default_home2 }}"
    state: directory

- name: Copy start page
  copy: src="{{ item.src }}" dest="{{ item.dest }}"
  with_items:
    - { src: 'index1.html', dest: "{{ default_home1 }}/index.html" }
    - { src: 'index2.html', dest: "{{ default_home2 }}/index.html" }
  tags:
    - copy::files

- name: Templates for nginx 2x virtual host
  template:
    src: "vhosts.j2"
    dest: "{{ nginx_cfg }}/vhost.conf"
    backup: yes
  become: yes
  tags:
    - nginx_vhost

- name: Templates for hosts
  template:
    src: "hosts.j2"
    dest: "/etc/hosts"
    backup: yes
  become: yes
  tags:
    - hosts_web

- name: Nginx. Restart servce
  service:
    name: nginx
    state: restarted
    enabled: yes

- name: Check content sites
  uri:
    url: "http://{{ hostvars[inventory_hostname].ansible_hostname }}.site1"
    return_content: yes 
  register: this
  failed_when: "'HEllo!' not in this.content "
  tags:
    - test_page
- debug:
    msg: "{{ this.status }}"
  tags:
    - test_code
