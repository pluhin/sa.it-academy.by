name: Docker Image CI Test

on:
  push:
  pull_request:

jobs:
  docker-image-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t app-under-test:ci .

      - name: Run container for tests
        run: |
          docker run -d -p 8080:8080 --name app-test app-under-test:ci
          sleep 3

      - name: Test HTTP endpoint
        run: |
          curl -f http://localhost:8080
          echo "SUCCESS: Application is accessible"

      - name: Test container runs as non-root
        run: |
          CONTAINER_UID=$(docker exec app-test id -u)
          echo "Container UID: $CONTAINER_UID"
          if [ "$CONTAINER_UID" -eq 0 ]; then
            echo "FAIL: Container is running as root"
            exit 1
          else
            echo "SUCCESS: Container is running as non-root user"
          fi

      - name: Cleanup
        if: always()
        run: |
          docker rm -f app-test || true
